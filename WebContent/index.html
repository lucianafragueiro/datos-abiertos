<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gr&aacute;fico de Infracciones de Transito</title>
</head>
<link rel="stylesheet" href="./lib/bootstrap/dist/css/bootstrap.css" />
<link rel="stylesheet" href="./lib/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="./css/jquery.dataTables.min.css" />
<!-- <script type="text/javascript" src="./lib/jQuery/dist/jquery.min.js"></script> -->
<script type="text/javascript" src="./lib/jquery-1.12.0.min.js"></script>
<script type="text/javascript"
	src="./lib/bootstrap/dist/js/bootstrap.js"></script>
<script type="text/javascript" src="./lib/leaflet/dist/leaflet.js"></script>
<script type="text/javascript" src="./lib/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="./lib/py-dptos.js"></script>
<script type="text/javascript" src="./lib/highcharts.js"></script>


<style>
#map {
	margin: 0 auto;
}

.td-title {
	font-weight: bold;
}

.legend {
	line-height: 18px;
	color: #555;
	text-align: right;
}

.legend i {
	width: 18px;
	height: 18px;
	float: left;
	margin-right: 8px;
	opacity: 0.8;
}

.info {
	background: rgba(255, 255, 255, 0.8) none repeat scroll 0 0;
	border-radius: 5px;
	font: 14px/16px Arial, Helvetica, sans-serif;
	padding: 6px 8px;
}

.info h4 {
	color: #777;
}
</style>
<body>

	<div class="container">
		<h3>Infracciones de Transitos</h3>
		<ul class="nav nav-tabs">
			<li class="active"><a data-toggle='tab' href="#mapa">Mapa</a></li>
			<li><a data-toggle='tab' href="#datos">Datos</a></li>
		</ul>
		<br>
	</div>
	<div class="tab-content">
		<div id="mapa" class="tab-pane fade in active">
			<div id="map" style="width: 80%; height: 450px;"></div>
			<div id='container' style='height: 500px; width: 700px; margin: 0 auto; display: none;'>
		</div>
		</div>
		<div id="datos" class="tab-pane fade in text-center">
			<div class="row">
				<div class="col-md-1"></div>
				<div class="col-md-10">
					<div class="table-responsive">
						<table id="tbl-multas" class="display  table-condensed"
							width="100%" cellspacing="0" style="font-size: 12px;")>
							<thead>
								<tr>
									<th>Multa</th>
									<th>Cod. Sanci&oacute;n</th>
									<th>Descripci&oacute;n</th>
									<th>Tipo Veh&iacute;culo</th>
									<th>Fecha Sanci&oacute;n</th>
									<th>Hora Sanci&oacute;n</th>
									<th>Monto</th>
									<th>Estado</th>
									<th>Fecha de Pago</th>
									<th>Ciudad del Registro</th>
									<th>Departamento del Registro</th>
									<th>Destacamento del Registro</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</div>


	<script type="text/javascript">
	    var html = "";
		var categorias = [];
		var series = [{
				'name':'Pagado',
				'data':[]
			},
			{
				'name':'Pendiente',
				'data':[]
			},
			{
				'name':'Amonestado',
				'data':[]
			}];
	$('document').ready(function(){
// 		var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
// 		var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 50});		
		var map = L.map('map').setView([-23.4510191,-58.0437109	], 6);
		//map.addLayer(osm);
		    map.dragging.disable();
            map.touchZoom.disable();
            map.doubleClickZoom.disable();
            map.scrollWheelZoom.disable();
            map.keyboard.disable();
		
		
			L.geoJson(statesData,{
				style:style,
					onEachFeature: function (feature, layer){
						//layer.bindPopup(createPopup(feature.properties.name,feature.properties.cantidad));
						layer.on({click:crearGrafico(feature.properties.name)});
						}
				}).addTo(map);

			loadTable();

			var legend = L.control({position: 'bottomright'});
			legend.onAdd = function (map) {
			    var div = L.DomUtil.create('div', 'legend'),
			        grades = [0, 10, 1000,5000, 10000, 30000, 50000,80000],
			        labels = [];
			    div.innerHTML="<span style='font-weight: bold;'> Cantidad de Infracciones</span> <br>";
			    for (var i = 0; i < grades.length; i++) {
			        div.innerHTML +=
			            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
			            grades[i] + (grades[i + 1] ? ' &ndash; ' + grades[i + 1] + '<br>' : '+');
			    }
			    return div;
			};
			legend.addTo(map);
			var info = L.control();

			info.onAdd = function (map) {
			    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
			    this.update();
			    return this._div;
			};

			info.update = function (props) {
			    this._div.innerHTML = (props ? createPopup(props.name, props.cantidad)   : '<span>Marque un Departamento</span>');
			};

			info.addTo(map);		
			
		}
	);

	function getColor(d) {
	    return d > 80000 ? '#800026' :
	           d > 50000  ? '#BD0026' :
	           d > 30000  ? '#E31A1C' :
	           d > 10000  ? '#FC4E2A' :
	           d > 5000   ? '#FD8D3C' :
	           d > 1000   ? '#FEB24C' :
	           d > 10   ? '#FED976' :
	                      '#FFEDA0';
	}

	function style(feature) {
	    return {
	        fillColor: getColor(feature.properties.cantidad),
	        weight: 2,
	        opacity: 1,
	        color: 'white',
	        dashArray: '3',
	        fillOpacity: 0.7
	    };
	}
		

	function loadTable(){
		
		$("#tbl-multas").DataTable(
				{
					"pagingType" : "full_numbers",
		 	        "processing": true,
		 	        "serverSide": true,
		 	        "ajax": {
		 	            "url": "datos.jsp",
		 	            "type": "POST"
		 	        },
		 	       scrollX:        true,
		 	        scrollCollapse: true,
		 	       fixedColumns:   {
		 	            leftColumns: 1,
		 	            rightColumns: 1
		 	        },
		 	       "columns": [
		 	                  { "data": "idMulta" },
		 	                  { "data": "codigoSancion" },
		 	                  { "data": "descripcion" },
		 	                  { "data": "tipoVehiculo" },
		 	                  { "data": "fechaSancion" },
		 	                  { "data": "horaSancion" },
		 	                  { "data": "monto" },
		 	                  { "data": "estadoMulta" },
		 	                  { "data": "fechaCobro" },
		 	                  { "data": "ciudadRegistroConducir" },
		 	                  { "data": "departamentoRegistroConducir" },
		 	                  { "data": "destacamento" }		 	                  
		 	              ],
					language : {
						"sProcessing" : "Procesando ...",
						"sLengthMenu" : "Mostrar _MENU_ registros",
						"sZeroRecords" : "No se encontraron resultados",
						"sEmptyTable" : "Ningún dato disponible en esta tabla",
						"sInfo" : "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
						"sInfoEmpty" : "Mostrando registros del 0 al 0 de un total de 0 registros",
						"sInfoFiltered" : "(filtrado de un total de _MAX_ registros)",
						"sInfoPostFix" : "",
						"sSearch" : "Buscar:",
						"sUrl" : "",
						"sInfoThousands" : ",",
						"sLoadingRecords" : "Cargando...",
						"oPaginate" : {
							"sFirst" : "Primero",
							"sLast" : "Último",
							"sNext" : "Siguiente",
							"sPrevious" : "Anterior"
						},
						"oAria" : {
							"sSortAscending" : ": Activar para ordenar la columna de manera ascendente",
							"sSortDescending" : ": Activar para ordenar la columna de manera descendente"
						}
					}
				});
		}

	function crearGrafico(dpto){
			$.ajax({
					url:'datos.jsp?dpto='+dpto,
					dataType:'json',
					success: function(data){
							categorias = data.categorias;
							for(var i=0;i<data.series.length;i++){
								series[0].data = data.series[i].estado[0].data;
								series[1].data = data.series[i].estado[1].data;
								series[2].data = data.series[i].estado[2].data;	
							}

							dibujarHisto();
							html = $("#container").css({display:"block"});
					}
				});
			//return html;
		}

	function dibujarHisto() {
		
		$('#container').highcharts({
			chart : {
				type : 'column'
			},
			title : {
				text : 'Listado de infracciones por cuidad de emision de Licencia'
			},
			exporting : {
				enabled : false
			},
			yAxis : {
				title : {
					text : 'Cantidad de Infracciones'
				}
			},
			xAxis : {
				categories : categorias
			},

			series : series
		});

	}

	

</script>
</body>
</html>
