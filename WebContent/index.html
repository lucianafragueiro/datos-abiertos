<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gr&aacute;fico de Infracciones de Transito</title>
</head>
<link rel="stylesheet" href="./lib/bootstrap/dist/css/bootstrap.css" />
<link rel="stylesheet" href="./lib/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="./css/jquery.dataTables.min.css" />
<!-- <script type="text/javascript" src="./lib/jQuery/dist/jquery.min.js"></script> -->
<script type="text/javascript" src="./lib/jquery-1.12.0.min.js"></script>
<script type="text/javascript"
	src="./lib/bootstrap/dist/js/bootstrap.js"></script>
<script type="text/javascript" src="./lib/leaflet/dist/leaflet.js"></script>
<script type="text/javascript" src="./lib/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="./lib/py-dptos.js"></script>
<script type="text/javascript" src="./lib/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>


<style>
#map {
	margin: 0 auto;
}

.td-title {
	font-weight: bold;
}

.legend {
	line-height: 18px;
	color: #555;
	text-align: right;
}

.legend i {
	width: 18px;
	height: 18px;
	float: left;
	margin-right: 8px;
	opacity: 0.8;
}

.info {
	background: rgba(255, 255, 255, 0.8) none repeat scroll 0 0;
	border-radius: 5px;
	font: 14px/16px Arial, Helvetica, sans-serif;
	padding: 6px 8px;
}

.info h4 {
	color: #777;
}
</style>
<body>

	<div class="container">
		<h3>Infracciones de Transitos</h3>
		<ul class="nav nav-tabs">
			<li class="active"><a data-toggle='tab' href="#mapa">Mapa</a></li>
			<li><a data-toggle='tab' href="#datos">Datos</a></li>
		</ul>
		<br>
	</div>
	<div class="tab-content">
		<div id="mapa" class="tab-pane fade in active">
			<div id="map" style="width: 80%; height: 450px;"></div>
			<div id='container'
				style='height: 70%; width: 80%; margin: 0 auto;'>
			</div>

		</div>
		<div id="datos" class="tab-pane fade in text-center">
			<div class="row">
				<div class="col-md-1"></div>
				<div class="col-md-10">
					<div class="table-responsive">
						<table id="tbl-multas" class="display  table-condensed"
							width="100%" cellspacing="0" style="font-size: 12px;")>
							<thead>
								<tr>
									<th>Multa</th>
									<th>Cod. Sanci&oacute;n</th>
									<th>Descripci&oacute;n</th>
									<th>Tipo Veh&iacute;culo</th>
									<th>Fecha Sanci&oacute;n</th>
									<th>Hora Sanci&oacute;n</th>
									<th>Monto</th>
									<th>Estado</th>
									<th>Fecha de Pago</th>
									<th>Ciudad del Registro</th>
									<th>Departamento del Registro</th>
									<th>Destacamento del Registro</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</div>


	<script type="text/javascript">
	    var html = "";
		var listCategorias = [];
		var listSeries = [];
	$('document').ready(function(){
// 		var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
// 		var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 50});		
		var map = L.map('map').setView([-23.4510191,-58.0437109	], 6);
		//map.addLayer(osm);
		    //map.dragging.disable();
            //map.touchZoom.disable();
            //map.doubleClickZoom.disable();
            map.scrollWheelZoom.disable();
            //map.keyboard.disable();
		
		
			L.geoJson(statesData,{
				style:style,
					onEachFeature: function (feature, layer){
						//layer.bindPopup(createPopup(feature.properties.name,feature.properties.cantidad));
						//layer.bindPopup(feature.properties.name, {closeButton: false});
                		//layer.on('mouseover', function() { layer.openPopup(); });
                		//layer.on('mouseout', function() { layer.closePopup(); });
						layer.on({click:crearGrafico});
						}
				}).addTo(map);

			loadTable();

			var legend = L.control({position: 'bottomright'});
			legend.onAdd = function (map) {
			    var div = L.DomUtil.create('div', 'legend'),
			        grades = [0, 10, 1000,5000, 10000, 30000, 50000,80000],
			        labels = [];
			    div.innerHTML="<span style='font-weight: bold;'> Cantidad de Infracciones</span> <br>";
			    for (var i = 0; i < grades.length; i++) {
			        div.innerHTML +=
			            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
			            grades[i] + (grades[i + 1] ? ' &ndash; ' + grades[i + 1] + '<br>' : '+');
			    }
			    return div;
			};
			legend.addTo(map);
			var info = L.control();

			info.onAdd = function (map) {
			    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
			    this.update();
			    return this._div;
			};

			info.update = function (props) {
			    this._div.innerHTML = (props ? createPopup(props.name, props.cantidad)   : '<span>Marque un Departamento</span>');
			};

			info.addTo(map);		
			
		}
	);

	function quitaAcentos(str){
		for (var i=0;i<str.length;i++){
		//Sustituye "á é í ó ú Ñ ñ"
		if (str.charAt(i)=="á") str = str.replace(/á/,"a");
		if (str.charAt(i)=="é") str = str.replace(/é/,"e");
		if (str.charAt(i)=="í") str = str.replace(/í/,"i");
		if (str.charAt(i)=="ó") str = str.replace(/ó/,"o");
		if (str.charAt(i)=="ú") str = str.replace(/ú/,"u");
		if (str.charAt(i)=="Ñ") str = str.replace(/Ñ/,"N");
		if (str.charAt(i)=="ñ") str = str.replace(/ñ/,"ñ");
		}
		return str;
		} 

	function getColor(d) {
	    return d > 80000 ? '#800026' :
	           d > 50000  ? '#BD0026' :
	           d > 30000  ? '#E31A1C' :
	           d > 10000  ? '#FC4E2A' :
	           d > 5000   ? '#FD8D3C' :
	           d > 1000   ? '#FEB24C' :
	           d > 10   ? '#FED976' :
	                      '#FFEDA0';
	}

	function style(feature) {
	    return {
	        fillColor: getColor(feature.properties.cantidad),
	        weight: 2,
	        opacity: 1,
	        color: 'white',
	        dashArray: '3',
	        fillOpacity: 0.7
	    };
	}
	$(function () {
	    $('#container').highcharts({

	        chart: {
	            type: 'bubble',
	            plotBorderWidth: 1,
	            zoomType: 'xy'
	        },
	        
	        tooltip: {
	            headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
	            pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.z}</b>'
	        },

	        title: {
	            text: 'Highcharts bubbles with radial gradient fill'
	        },

	        xAxis: {
	            gridLineWidth: 1,
	            max: 12,
	            min : 1,
	            allowDecimals: false,
	            title: {
		            text: 'Meses'}
	        },

	        yAxis: {
	            startOnTick: false,
	            endOnTick: false,
	            allowDecimals: false,
	            title: {
		            text: 'Cantidad de Infracciones'}
	        },

	        series: [{
		        name: 'Montos 2014',
	            data: [
[1,3906,1000552236],
[2,3163,859542292],
[3,4306,1311485032],
[4,4068,1278871724],
[5,5094,1533148168],
[6,4005,1197665636],
[7,4599,1269067772],
[8,5187,1648785888],
[9,4869,1600482056],
[10,5100,1758988332],
[11,4103,1371644332],
[12,4042,1354504400]
	            ],
	            marker: {
	                fillColor: {
	                    radialGradient: { cx: 0.4, cy: 0.3, r: 0.7 },
	                    stops: [
	                        [0, 'rgba(255,255,255,0.5)'],
	                        [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0.5).get('rgba')]
	                    ]
	                }
	            }
	        }, {
		        name: 'Montos 2015',
	            data: [
[1,4828,1542080144],
[2,4606,1405904540],
[3,5133,1618420636],
[4,4793,1687548372],
[5,3738,1304140092],
[6,2617,1224693252],
[7,1512,692705580],
[8,1766,816660256],
[9,1772,825795044],
[10,1936,870324916],
[11,2301,1046796016],
[12,2728,1275219996]
	            ],
	            marker: {
	                fillColor: {
	                    radialGradient: { cx: 0.4, cy: 0.3, r: 0.7 },
	                    stops: [
	                        [0, 'rgba(255,255,255,0.5)'],
	                        [1, Highcharts.Color(Highcharts.getOptions().colors[1]).setOpacity(0.5).get('rgba')]
	                    ]
	                }
	            }
	        }]

	    });
	});
		

	function loadTable(){
		
		$("#tbl-multas").DataTable(
				{
					"pagingType" : "full_numbers",
		 	        "processing": true,
		 	        "serverSide": true,
		 	        "ajax": {
		 	            "url": "datos.jsp",
		 	            "type": "POST"
		 	        },
		 	       scrollX:        true,
		 	        scrollCollapse: true,
		 	       fixedColumns:   {
		 	            leftColumns: 1,
		 	            rightColumns: 1
		 	        },
		 	       "columns": [
		 	                  { "data": "idMulta" },
		 	                  { "data": "codigoSancion" },
		 	                  { "data": "descripcion" },
		 	                  { "data": "tipoVehiculo" },
		 	                  { "data": "fechaSancion" },
		 	                  { "data": "horaSancion" },
		 	                  { "data": "monto" },
		 	                  { "data": "estadoMulta" },
		 	                  { "data": "fechaCobro" },
		 	                  { "data": "ciudadRegistroConducir" },
		 	                  { "data": "departamentoRegistroConducir" },
		 	                  { "data": "destacamento" }		 	                  
		 	              ],
					language : {
						"sProcessing" : "Procesando ...",
						"sLengthMenu" : "Mostrar _MENU_ registros",
						"sZeroRecords" : "No se encontraron resultados",
						"sEmptyTable" : "Ningún dato disponible en esta tabla",
						"sInfo" : "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
						"sInfoEmpty" : "Mostrando registros del 0 al 0 de un total de 0 registros",
						"sInfoFiltered" : "(filtrado de un total de _MAX_ registros)",
						"sInfoPostFix" : "",
						"sSearch" : "Buscar:",
						"sUrl" : "",
						"sInfoThousands" : ",",
						"sLoadingRecords" : "Cargando...",
						"oPaginate" : {
							"sFirst" : "Primero",
							"sLast" : "Último",
							"sNext" : "Siguiente",
							"sPrevious" : "Anterior"
						},
						"oAria" : {
							"sSortAscending" : ": Activar para ordenar la columna de manera ascendente",
							"sSortDescending" : ": Activar para ordenar la columna de manera descendente"
						}
					}
				});
		}

	function crearGrafico(ev){
			var dpto = ev.target.feature.properties.name;
			$('#myModal').modal('show');
			$.ajax({
					url:'datos.jsp?dpto='+quitaAcentos(dpto),
					contentType: "application/json; charset=utf-8",
					dataType:'json',
					success: function(data){
						listSeries = [{
							'name':'Pagado',
							'data':[]
						},
						{
							'name':'Pendiente',
							'data':[]
						},
						{
							'name':'Amonestado',
							'data':[]
						}];
						listCategorias = data.categorias;
							for(var i=0;i<data.series.length;i++){
								listSeries[0].data[i] = data.series[i].estado[0].data;
								listSeries[1].data[i] = data.series[i].estado[1].data;
								listSeries[2].data[i] = data.series[i].estado[2].data;	
							}
							$("#container").html("");
							dibujarHisto(dpto);
							$("#container").css({display:"block"});
							$('#myModal').modal('hide')
					},
					error:function(){
						$('#myModal').modal('hide')
						}
				});
		}

	function dibujarHisto(dpto) {
		
		$('#container').highcharts({
			chart : {
				type : 'column'
			},
			title : {
				text : '<h3>Departamento  '+dpto+'</h3>'
			},
			subtitle:{
				text: "Listado de infracciones por cuidad de emision de Licencia"
				},
			exporting : {
				enabled : false
			},
			yAxis : {
				allowDecimals: false,
				min:0,
				title : {
					text : 'Cantidad de Infracciones'
				}
			},
			xAxis : {
				categories : listCategorias,
				title : {
					text : 'Distritos emisor de Licencias'
				},
				type: 'category',
				 labels: {
		                rotation: -45,
		                style: {
		                    fontSize: '8px',
		                    fontFamily: 'Verdana, sans-serif'
		                }
		            }
			},

			series : listSeries
		});

	}
</script>
	<div id="myModal" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Procesando....</h4>
				</div>
				<div class="modal-body text-center">
					<img alt="loading" src="images/ajax-loader.gif">
				</div>
			</div>
		</div>
	</div>
</body>
</html>
